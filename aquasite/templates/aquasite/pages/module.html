{% extends 'aquasite/partials/base.html' %}

{% block title %}AQUA | Módulo {{moduleId}}{% endblock %}

{% block body-content %}
{% include 'aquasite/partials/dashboard-navbar.html' %}
  <section id="module" data-module-id="{{moduleId}}">
    <div class="container mt-5">
      <nav class="pt-4" style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Painel</a></li>
          <li class="breadcrumb-item active" aria-current="page">Módulo</li>
        </ol>
      </nav>
  
      <p>Nome do módulo: {{moduleName}}</p>

      <div class="row">
        <div class="chart-container col" style="width: 30vw;">
          <canvas id="temperature-chart"></canvas>
        </div>

        <div class="chart-container col" style="width: 30vw;">
          <canvas id="level-chart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const temperatureChartCanvas = document.getElementById('temperature-chart');
    let temperatureChartData = {
      type: 'line',
      data: {
        labels: ['', '', '', '', ''],
        datasets: [{
          label: 'Temperatura da água',
          data: [20, 20, 20, 20, 20],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            min: 0,
            max: 100,
          }
        },
      }
    }
    let temperatureChart = new Chart(temperatureChartCanvas, temperatureChartData)

    const levelChartCanvas = document.getElementById('level-chart');
    let levelChartData = {
      type: 'bar',
      data: {
        labels: ['', '', '', '', ''],
        datasets: [{
          label: 'Nível da água',
          data: [20, 20, 20, 20, 20],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            min: 0,
            max: 50,
          }
        },
      }
    }
    let levelChart = new Chart(levelChartCanvas, levelChartData)


    const moduleId = document.getElementById('module').getAttribute('data-module-id')
    let moduleSocket = new WebSocket(
      'ws://' +
      window.location.host +
      '/dashboard/module/' +
      moduleId +
      '/'
    )
    moduleSocket.onmessage = (e) => {
      const djangoData = JSON.parse(e.data)
      console.log(djangoData)

      let newTemperatureChartData = temperatureChartData.data.datasets[0].data
      newTemperatureChartData.shift()
      newTemperatureChartData.push(djangoData.temperature)
      temperatureChartData.data.datasets[0].data = newTemperatureChartData
      temperatureChart.update()

      let newLevelChartData = levelChartData.data.datasets[0].data
      newLevelChartData.shift()
      newLevelChartData.push(djangoData.level)
      levelChartData.data.datasets[0].data = newLevelChartData
      levelChart.update()
    }
  </script>
{% endblock %}